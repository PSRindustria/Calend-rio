<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>Painel de Cards</title>
  <style>
    body { font-family: sans-serif; padding:1rem; max-width:600px; margin:auto;}
    #status { margin-bottom:1rem; font-weight:bold;}
    ul { list-style:none; padding:0;}
    li {
      display:flex; justify-content:space-between; align-items:center;
      padding:.5rem; border:1px solid #ccc; border-radius:4px; margin-bottom:.5rem;
    }
    li:hover { background:#f5f5f5;}
    .text-item { cursor:pointer; flex:1; }
    .btn-comment {
      margin-left:.5rem; padding:.25rem .5rem; border:none;
      background:#007bff; color:#fff; border-radius:3px; cursor:pointer;
    }
    .btn-comment:hover { background:#0056b3; }
  </style>
</head>
<body>
  <h1>Painel de Cards</h1>
  <div id="status">Carregandoâ€¦</div>
  <ul id="lista"></ul>

  <script>
    /**
     * 1) Puxa os dados via Apps Script
     */
    function loadData() {
      const status = document.getElementById('status');
      status.textContent = 'Carregandoâ€¦';
      console.log('> chamando getData()');

      google.script.run
        .withSuccessHandler(render)
        .withFailureHandler(err => {
          status.textContent = 'Erro ao carregar: ' + err.message;
          console.error('ðŸ’¥ getData falhou:', err);
        })
        .getData();
    }

    /**
     * 2) Renderiza lista de cards
     */
    function render(items) {
      console.log('âœ… render recebeu:', items);
      const lista = document.getElementById('lista');
      const status = document.getElementById('status');
      lista.innerHTML = '';

      if (!items || items.length === 0) {
        lista.innerHTML = '<li>Nenhum registro</li>';
        status.textContent = '';
        return;
      }

      items.forEach(item => {
        const li = document.createElement('li');

        // texto (excluindo _row, comments, commentCount)
        const txt = document.createElement('div');
        txt.className = 'text-item';
        const display = Object.entries(item)
          .filter(([k]) => !['_row','comments','commentCount'].includes(k))
          .map(([k,v]) => `${k}: ${v}`)
          .join(' â”‚ ');
        txt.textContent = display;
        txt.title = 'Clique para editar Coluna I';

        // botÃ£o comentÃ¡rios
        const btn = document.createElement('button');
        btn.className = 'btn-comment';
        btn.textContent = `ComentÃ¡rios (${item.commentCount||0})`;

        // editar coluna I
        txt.addEventListener('click', () => {
          const atual = item.I||'';
          const novo = prompt('Valor para coluna I:', atual);
          if (novo !== null) {
            console.log(`> updateColumnI linha=${item._row} valor=${novo}`);
            google.script.run
              .withSuccessHandler(() => {
                item.I = novo;
                txt.textContent = Object.entries(item)
                  .filter(([k])=>!['_row','comments','commentCount'].includes(k))
                  .map(([k,v])=>`${k}: ${v}`)
                  .join(' â”‚ ');
                status.textContent = 'Coluna I atualizada!';
              })
              .withFailureHandler(err => {
                status.textContent = 'Erro ao atualizar I: ' + err.message;
                console.error('ðŸ’¥ updateColumnI falhou:', err);
              })
              .updateColumnI(item._row, novo);
          }
        });

        // adicionar comentÃ¡rio
        btn.addEventListener('click', () => {
          const anteriores = item.comments || '';
          const msg = anteriores
            ? `ComentÃ¡rios anteriores:\n${anteriores}\n\nNovo comentÃ¡rio:`
            : 'Digite seu comentÃ¡rio:';
          const novo = prompt(msg);
          if (novo && novo.trim()) {
            console.log(`> addComment linha=${item._row} texto=${novo}`);
            google.script.run
              .withSuccessHandler(() => {
                item.comments = anteriores
                  ? anteriores + '\n' + novo.trim()
                  : novo.trim();
                item.commentCount = (item.commentCount||0) + 1;
                btn.textContent = `ComentÃ¡rios (${item.commentCount})`;
                status.textContent = 'ComentÃ¡rio salvo!';
              })
              .withFailureHandler(err => {
                status.textContent = 'Erro ao salvar comentÃ¡rio: ' + err.message;
                console.error('ðŸ’¥ addComment falhou:', err);
              })
              .addComment(item._row, novo.trim());
          }
        });

        li.appendChild(txt);
        li.appendChild(btn);
        lista.appendChild(li);
      });

      status.textContent = `Foram carregados ${items.length} registros.`;
    }

    // dispara ao carregar a pÃ¡gina
    window.onload = loadData;
  </script>
</body>
</html>

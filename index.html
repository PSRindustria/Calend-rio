<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Cards</title>
  <style>
    body { font-family: sans-serif; max-width:600px; margin:auto; padding:1rem; }
    h1 { text-align:center; }
    #status { font-weight:bold; margin-bottom:1rem; }
    ul { list-style:none; padding:0; }
    li {
      display:flex; justify-content:space-between; align-items:center;
      padding:.5rem; border:1px solid #ccc; border-radius:4px; margin-bottom:.5rem;
    }
    li:hover { background:#f5f5f5; }
    .text-item { flex:1; cursor:pointer; }
    .btn { margin-left:.5rem; padding:.25rem .5rem; border:none; border-radius:3px; cursor:pointer; }
    .btn-edit { background:#28a745; color:#fff; }
    .btn-comment { background:#007bff; color:#fff; }
    .btn-edit:hover { background:#218838; }
    .btn-comment:hover { background:#0056b3; }
    /* Adicionado para mostrar mensagens de depuração */
    #debug { margin-top:1rem; padding:.5rem; border:1px dashed #ccc; display:none; }
  </style>
</head>
<body>
  <h1>Painel de Cards</h1>
  <div id="status">Carregando…</div>
  <ul id="lista"></ul>
  <div id="debug"></div>

  <script>
    // URL do seu Web App Apps Script - URL ATUALIZADA
    const WEB_APP = 'https://script.google.com/macros/s/AKfycby8yXZAoOsfkc6Mlt0jcs3lK2V0l-zM6nWo00otZhIajM_Odi24VFsBmdZJDKMaI_9hcw/exec';

    // Mostrar mensagens de depuração
    function debug(message) {
      const debugDiv = document.getElementById('debug');
      debugDiv.style.display = 'block';
      debugDiv.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
    }

    // 1) JSONP GET para buscar os dados
    function loadData() {
      document.getElementById('status').textContent = 'Carregando…';
      window.handleData = function(items) {
        render(items);
        document.getElementById('status').textContent = `Foram carregados ${items.length} registros.`;
        delete window.handleData;
      };
      const s = document.createElement('script');
      s.src = `${WEB_APP}?action=getData&callback=handleData`;
      document.head.appendChild(s);
    }

    // 2) Renderiza cada registro como um card
    function render(items) {
      const ul = document.getElementById('lista');
      ul.innerHTML = '';
      if (!items || items.length === 0) {
        ul.innerHTML = '<li>Nenhum registro</li>';
        return;
      }
      items.forEach(item => {
        const li = document.createElement('li');

        // Texto principal (exclui campos internos)
        const txt = document.createElement('div');
        txt.className = 'text-item';
        txt.textContent = Object.entries(item)
          .filter(([k])=>!['_row','comments','commentCount'].includes(k))
          .map(([k,v])=>`${k}: ${v}`)
          .join(' │ ');

        // Botão para editar I
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-edit';
        btnEdit.textContent = `I: ${item.I||''}`;
        btnEdit.onclick = () => {
          const novo = prompt('Valor para coluna I:', item.I||'');
          if (novo === null) return;
          
          debug(`Enviando atualização para linha ${item._row}, valor: ${novo}`);
          
          // Dados a serem enviados
          const data = {
            action: 'updateI',
            row: item._row,
            value: novo
          };
          
          // Enviar via fetch API
          fetch(WEB_APP, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(response => {
            debug(`Resposta recebida para atualização`);
            setTimeout(loadData, 1000); // Recarregar após 1 segundo
          })
          .catch(error => {
            debug(`Erro ao atualizar: ${error}`);
          });
        };

        // Botão para comentários
        const btnC = document.createElement('button');
        btnC.className = 'btn btn-comment';
        btnC.textContent = `Comentários (${item.commentCount||0})`;
        btnC.onclick = () => {
          const antigas = Array.isArray(item.comments) ? item.comments.join('\n') : '';
          const msg = antigas
            ? `Comentários anteriores:\n${antigas}\n\nNovo:`
            : 'Digite seu comentário:';
          const novo = prompt(msg);
          if (!novo) return;
          
          debug(`Enviando comentário para linha ${item._row}: ${novo}`);
          
          // Dados a serem enviados
          const data = {
            action: 'addComment',
            row: item._row,
            comment: novo
          };
          
          // Enviar via fetch API
          fetch(WEB_APP, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(response => {
            debug(`Resposta recebida para comentário`);
            setTimeout(loadData, 1000); // Recarregar após 1 segundo
          })
          .catch(error => {
            debug(`Erro ao adicionar comentário: ${error}`);
          });
        };

        li.append(txt, btnEdit, btnC);
        ul.appendChild(li);
      });
    }

    // Inicia ao carregar a página
    window.onload = loadData;
  </script>
</body>
</html>

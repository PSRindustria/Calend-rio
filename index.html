<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Cards Interativo V4</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --success: #4cc9f0; /* Azul claro para botão Aprovação */
      --secondary: #3f37c9; /* Azul mais escuro para botão Comentar */
      --warning: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --border-radius: 8px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
      background-color: #f0f2f5;
      color: var(--dark);
    }
    
    .header h1 {
      color: var(--primary);
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    
    #status {
      font-weight: 500;
      color: var(--gray);
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .date-navigator {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .date-btn {
      background-color: white;
      border: 1px solid var(--primary-light);
      color: var(--primary);
      border-radius: var(--border-radius);
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: var(--transition);
    }
    .date-btn:hover { background-color: var(--primary-light); color: white; }
    .date-btn.active { background-color: var(--primary); color: white; }
    
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      transition: var(--transition);
      overflow: hidden;
      /* cursor: pointer; /* Removido para que o clique seja no header para expandir */
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    
    .card-header {
      background-color: var(--primary);
      color: white;
      padding: 0.75rem 1rem;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer; /* Adicionado para indicar que o header é clicável */
    }
    .card.aprovacao-aprovado .card-header { background-color: #28a745; }
    .card.aprovacao-reprovado .card-header { background-color: #dc3545; }
    .card.aprovacao-pendente .card-header, .card.aprovacao-em-andamento .card-header { background-color: #ffc107; color: #212529; }
    
    .card-title {
      display: flex; align-items: center; gap: 6px; font-weight: bold;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: calc(100% - 30px); /* Ajuste para caber o ícone */
    }
    .social-icon { font-size: 18px; margin-right: 6px; flex-shrink: 0; }
    .expand-icon { transition: transform 0.3s ease; }
    .card.expanded .expand-icon { transform: rotate(180deg); }
    
    .card-content-wrapper {
      padding: 1rem;
    }

    .card-summary, .card-details {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .card-details {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.5s ease-out, opacity 0.3s ease-out, margin-top 0.5s ease-out, padding-top 0.5s ease-out;
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }

    .card.expanded .card-details {
      max-height: 1500px; /* Um valor grande o suficiente */
      opacity: 1;
      margin-top: 1rem; 
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }
    
    .card-field-custom {
      text-align: center;
    }
    .field-label-custom {
      font-weight: bold; color: var(--dark); display: block;
      margin-bottom: 0.3rem; font-size: 0.9em;
    }
    .field-value-custom {
      word-break: break-word; display: block; font-size: 0.85em; color: var(--gray);
    }
    .field-value-custom a.link-field {
      color: var(--primary); text-decoration: none; display: inline-flex;
      align-items: center; gap: 5px; justify-content: center;
    }
    .field-value-custom a.link-field:hover { text-decoration: underline; }
    .field-value-custom div.comment-item { margin-bottom: 4px; text-align: left; white-space: pre-wrap; }

    .dates-group .field-label-custom { margin-bottom: 0.5rem; }
    .dates-group .date-pair {
        display: flex; 
        justify-content: space-around;
        gap: 0.5rem;
        text-align: center;
    }
    .dates-group .date-item {
        flex: 1;
    }
    .dates-group .date-item .field-label-custom { font-size: 0.8em; margin-bottom: 0.1rem; }
    .dates-group .date-item .field-value-custom { font-size: 0.8em; }

    .card-actions {
      display: flex;
      justify-content: space-around;
      gap: 1rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed #eee;
    }
    .btn-action {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9em;
    }
    .btn-action i { font-size: 1.1em; }
    .btn-aprovacao {
      background-color: var(--success);
      color: white;
    }
    .btn-aprovacao:hover { background-color: #3db8db; }
    .btn-comentar {
      background-color: var(--secondary);
      color: white;
    }
    .btn-comentar:hover { background-color: var(--primary); }

    .empty-state { text-align: center; padding: 2rem; background-color: white; border-radius: var(--border-radius); box-shadow: var(--shadow); grid-column: 1 / -1; }
    .empty-state i { font-size: 3rem; color: var(--gray); margin-bottom: 1rem; }
    .empty-state h3 { color: var(--gray); margin-bottom: 0.5rem; }
    
    .debug-panel { margin-top: 2rem; padding: 1rem; border: 1px dashed #ccc; border-radius: var(--border-radius); display: none; background-color: #f8f9fa; }
    .debug-panel h3 { color: var(--gray); margin-top: 0; font-size: 1rem; }
    .debug-content { max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 14px; }
  </style>
</head>
<body>
  <div class="header"><h1>Painel de Cards Interativo V4</h1></div>
  <div id="status">Carregando dados...</div>
  <div class="date-navigator" id="dateFilter"></div>
  <div id="cardContainer" class="card-container"></div>
  <div id="debug" class="debug-panel"><h3>Log de Depuração</h3><div class="debug-content"></div></div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby8yXZAoOsfkc6Mlt0jcs3lK2V0l-zM6nWo00otZhIajM_Odi24VFsBmdZJDKMaI_9hcw/exec';
    let allData = [];
    let availableDates = [];
    let currentDateFilter = null;

    function debug(message) {
      const debugPanel = document.getElementById('debug');
      const debugContent = debugPanel.querySelector('.debug-content');
      if (debugPanel && debugContent) {
        debugPanel.style.display = 'block';
        const timestamp = new Date().toLocaleTimeString();
        debugContent.innerHTML += `<div>${timestamp}: ${message}</div>`;
      }
    }

    function loadData() {
      document.getElementById('status').textContent = 'Carregando dados...';
      window.handleDataCallback = function(items) {
        allData = items.map(item => ({ ...item, _internalId: Math.random().toString(36).substr(2, 9) })); // _row é o ID da planilha
        extractDates();
        renderDateFilters();
        const initialDateFilter = findInitialDateFilter();
        filterByDate(initialDateFilter);
        document.getElementById('status').textContent = `${allData.length} registros carregados.`;
        delete window.handleDataCallback;
      };
      const scriptEl = document.createElement('script');
      scriptEl.src = `${WEB_APP_URL}?action=getData&callback=handleDataCallback&nocache=${new Date().getTime()}`;
      document.head.appendChild(scriptEl);
      scriptEl.onerror = () => {
        debug('Falha ao carregar dados do WEB_APP.');
        document.getElementById('status').textContent = 'Erro ao carregar dados.';
        delete window.handleDataCallback;
      };
    }

    function findInitialDateFilter() {
        if (availableDates.length === 0) return null;
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        let targetDateFilter = availableDates.find(d => d.year === currentYear && d.month === currentMonth);
        if (!targetDateFilter) {
            const sortedDates = [...availableDates].sort((a,b) => (b.year * 100 + b.month) - (a.year*100 + a.month));
            targetDateFilter = sortedDates[0] || null;
        }
        return targetDateFilter;
    }
    
    function extractDates() {
      const dateFieldKey = findDateFieldKey();
      if (!dateFieldKey) {
        debug("Nenhum campo de data (postagem) identificado para filtro.");
        availableDates = []; return;
      }
      const dateMap = {};
      allData.forEach(item => {
        const dateValueStr = getFieldValue(item, [dateFieldKey]);
        if (dateValueStr) {
          let dateValue = parseDate(dateValueStr);
          if (dateValue && !isNaN(dateValue.getTime())) {
            const month = dateValue.getMonth();
            const year = dateValue.getFullYear();
            const key = `${year}-${month}`;
            if (!dateMap[key]) {
              dateMap[key] = { year: year, month: month, label: getMonthName(month) + ' ' + year };
            }
          }
        }
      });
      availableDates = Object.values(dateMap).sort((a, b) => (b.year * 100 + b.month) - (a.year * 100 + a.month));
    }
    
    function findDateFieldKey() {
      if (allData.length === 0) return null;
      const possibleKeys = ['Data da Postagem', 'Data Postagem', 'dataPostagem', 'Data', 'Data:', 'date', 'dt', 'dataCriacao', 'dataRegistro', 'dataEntrada'];
      const firstItemKeys = Object.keys(allData[0]);
      for (const pk of possibleKeys) {
        if (firstItemKeys.includes(pk)) return pk;
      }
      for (const key of firstItemKeys) {
        const value = allData[0][key];
        if (value && typeof value === 'string' && (value.includes('/') || value.match(/^\d{4}-\d{2}-\d{2}/) || !isNaN(new Date(value).getTime()))) return key;
        if (value instanceof Date) return key;
      }
      return null;
    }
    
    function getMonthName(monthIndex) {
      const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      return months[monthIndex];
    }
    
    function renderDateFilters() {
      const filterContainer = document.getElementById('dateFilter');
      filterContainer.innerHTML = '';
      if (availableDates.length === 0) return;

      const allButton = document.createElement('button');
      allButton.className = 'date-btn' + (currentDateFilter === null ? ' active' : '');
      allButton.textContent = 'Todos';
      allButton.onclick = () => filterByDate(null);
      filterContainer.appendChild(allButton);

      availableDates.forEach(dateObj => {
        const btn = document.createElement('button');
        btn.className = 'date-btn';
        if (currentDateFilter && currentDateFilter.year === dateObj.year && currentDateFilter.month === dateObj.month) {
          btn.classList.add('active');
        }
        btn.textContent = dateObj.label;
        btn.onclick = () => filterByDate(dateObj);
        filterContainer.appendChild(btn);
      });
    }
    
    function filterByDate(dateObj) {
      currentDateFilter = dateObj;
      document.querySelectorAll('#dateFilter .date-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtnLabel = dateObj ? dateObj.label : 'Todos';
      document.querySelectorAll('#dateFilter .date-btn').forEach(btn => {
        if (btn.textContent === activeBtnLabel) btn.classList.add('active');
      });
      
      const dateFieldKey = findDateFieldKey();
      let filteredData = allData;
      if (dateObj && dateFieldKey) {
        filteredData = allData.filter(item => {
          const itemDateStr = getFieldValue(item, [dateFieldKey]);
          if (!itemDateStr) return false;
          let itemDate = parseDate(itemDateStr);
          return itemDate && itemDate.getMonth() === dateObj.month && itemDate.getFullYear() === dateObj.year;
        });
      }
      renderCards(sortDataByDate(filteredData, dateFieldKey));
    }

    function sortDataByDate(dataArray, dateFieldKey) {
        if (!dateFieldKey) return dataArray;
        return [...dataArray].sort((a, b) => {
            const dateA = parseDate(getFieldValue(a, [dateFieldKey]));
            const dateB = parseDate(getFieldValue(b, [dateFieldKey]));
            if (!dateA && !dateB) return 0;
            if (!dateA) return 1;
            if (!dateB) return -1;
            return dateB.getTime() - dateA.getTime();
        });
    }
    
    function parseDate(dateStr) {
      if (!dateStr) return null;
      if (dateStr instanceof Date) return dateStr;
      if (typeof dateStr === 'string') {
        try {
          if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
              let d = new Date(parts[2], parts[1]-1, parts[0]);
              if (isNaN(d.getTime())) d = new Date(parts[2], parts[0]-1, parts[1]);
              return !isNaN(d.getTime()) ? d : null;
            } else if (parts.length === 2) {
              const d = new Date(new Date().getFullYear(), parts[1]-1, parts[0]);
              return !isNaN(d.getTime()) ? d : null;
            }
          } else if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
             const d = new Date(dateStr);
             return !isNaN(d.getTime()) ? d : null;
          }
          const d = new Date(dateStr);
          return !isNaN(d.getTime()) ? d : null;
        } catch (e) { debug(`Erro ao analisar data: ${dateStr} -> ${e.message}`); }
      }
      return null;
    }

    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return String(unsafe).replace(/[&<"']/g, m => ({ '&': '&amp;', '<': '&lt;', '"': '&quot;', "'": '&#039;' }[m]));
    }

    function getFieldValue(item, possibleKeys, defaultValue = undefined) {
      for (const key of possibleKeys) {
        if (item.hasOwnProperty(key) && item[key] !== null && item[key] !== undefined && String(item[key]).trim() !== '') {
          return item[key];
        }
      }
      return defaultValue;
    }

    function getSocialIcon(platform) {
      if (!platform) return '';
      platform = String(platform).toLowerCase();
      if (platform.includes('instagram')) return '<i class="fab fa-instagram social-icon"></i>';
      if (platform.includes('facebook')) return '<i class="fab fa-facebook social-icon"></i>';
      if (platform.includes('tiktok')) return '<i class="fab fa-tiktok social-icon"></i>';
      if (platform.includes('youtube')) return '<i class="fab fa-youtube social-icon"></i>';
      return '';
    }

    function formatDisplayDate(dateValue) {
        if (!dateValue) return 'N/A';
        const dateObj = parseDate(dateValue);
        return dateObj ? dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : escapeHtml(String(dateValue));
    }

    function renderSingleField(item, config) {
        let fieldValue = getFieldValue(item, config.keys);
        if (fieldValue === undefined && config.title !== 'Comentários:') return '';
        
        let displayValue = '';
        if (config.isLink && typeof fieldValue === 'string' && (fieldValue.startsWith('http://') || fieldValue.startsWith('https://'))) {
            displayValue = `<a href="${escapeHtml(fieldValue)}" target="_blank" class="link-field"><i class="fas fa-link"></i> ${escapeHtml(fieldValue)}</a>`;
        } else if (config.isDate) {
            displayValue = formatDisplayDate(fieldValue);
        } else if (config.title === 'Comentários:') {
            const commentsRaw = getFieldValue(item, config.keys, '');
            let commentsArray = [];
            if (typeof commentsRaw === 'string' && commentsRaw.trim() !== '') {
                commentsArray = commentsRaw.split('\n');
            } else if (Array.isArray(commentsRaw)){
                commentsArray = commentsRaw;
            }
            displayValue = commentsArray.map(c => `<div class="comment-item">${escapeHtml(String(c))}</div>`).join('');
            if (!displayValue && !item.hasOwnProperty(config.keys.find(k => item.hasOwnProperty(k)))) return '';
        } else {
            displayValue = escapeHtml(String(fieldValue));
        }

        return `
          <div class="card-field-custom">
            <div class="field-label-custom">${escapeHtml(config.title)}</div>
            <div class="field-value-custom">${displayValue || (config.title === 'Comentários:' ? '(Sem comentários)' : 'N/A')}</div>
          </div>`;
    }

    function renderCards(items) {
      const container = document.getElementById('cardContainer');
      container.innerHTML = '';
      
      if (!items || items.length === 0) {
        container.innerHTML = `<div class="empty-state"><i class="fas fa-search"></i><h3>Nenhum registro encontrado</h3><p>Tente selecionar outro período ou verifique os dados.</p></div>`;
        return;
      }
      
      const summaryFieldsConfig = [
        { title: 'Status:', keys: ['Status', 'Status:'] },
        { title: 'Assunto:', keys: ['Assunto', 'Assunto:'] },
        { title: 'Observação:', keys: ['Observação', 'Observacao', 'Observacão'] }
      ];

      const detailFieldsConfig = [
        { title: 'Aprovação:', keys: ['Aprovação', 'Aprovacao'] },
        { title: 'Plataforma:', keys: ['Plataforma'] },
        { title: 'Link do Drive:', keys: ['Link do Drive', 'Link Drive', 'Drive'], isLink: true },
        { title: 'Comentários:', keys: ['comments', 'Comentários', 'Comentarios'] }
      ];

      items.forEach(item => {
        const sheetRowId = item._row; // Usar _row diretamente para interações com a planilha
        if (sheetRowId === undefined) {
            debug(`Item sem _row: ${JSON.stringify(item)}`);
            // return; // Pular renderização de cards sem _row ou tratar de outra forma
        }

        const aprovacaoStatus = getFieldValue(item, ['Aprovação', 'Aprovacao']);
        const cardClass = `card ${aprovacaoStatus ? `aprovacao-${String(aprovacaoStatus).toLowerCase().replace(/[^a-z0-9-]/g, '')}` : ''}`.trim();
        
        let cardHtml = `<div class="${cardClass}" data-internal-id="${item._internalId}">`;

        const plataforma = getFieldValue(item, ['Plataforma']);
        const socialIconHtml = getSocialIcon(plataforma);
        // O título do card é o campo 'Nome' ou 'Título' ou 'Assunto'
        const cardTitleText = escapeHtml(getFieldValue(item, ['Nome', 'Título', 'Title', 'Assunto'], 'Card Sem Título'));
        
        cardHtml += `
          <div class="card-header" data-sheet-row="${sheetRowId}">
            <span class="card-title">${socialIconHtml}${cardTitleText}</span>
            <i class="fas fa-chevron-down expand-icon"></i>
          </div>`;

        cardHtml += '<div class="card-content-wrapper">';
        cardHtml += '<div class="card-summary">';

        summaryFieldsConfig.forEach(config => {
          cardHtml += renderSingleField(item, config);
        });

        const dataPostagem = getFieldValue(item, ['Data da Postagem', 'Data Postagem']);
        const dataEntrega = getFieldValue(item, ['Data de Entrega', 'Data Entrega']);
        cardHtml += `
          <div class="card-field-custom dates-group">
            <div class="date-pair">
              <div class="date-item">
                <div class="field-label-custom">Data da Postagem:</div>
                <div class="field-value-custom">${formatDisplayDate(dataPostagem)}</div>
              </div>
              <div class="date-item">
                <div class="field-label-custom">Data de Entrega:</div>
                <div class="field-value-custom">${formatDisplayDate(dataEntrega)}</div>
              </div>
            </div>
          </div>`;

        cardHtml += '</div>'; 
        cardHtml += '<div class="card-details">';

        detailFieldsConfig.forEach(config => {
          cardHtml += renderSingleField(item, config);
        });
        
        cardHtml += `
          <div class="card-actions">
            <button class="btn-action btn-aprovacao" data-sheet-row="${sheetRowId}"><i class="fas fa-star"></i> Aprovação</button>
            <button class="btn-action btn-comentar" data-sheet-row="${sheetRowId}"><i class="fas fa-comment"></i> Comentar</button>
          </div>`;

        cardHtml += '</div>';
        cardHtml += '</div>';
        cardHtml += '</div>';
        container.innerHTML += cardHtml;
      });

      addCardEventListeners();
    }

    function addCardEventListeners() {
        document.querySelectorAll('.card-header').forEach(header => {
            header.addEventListener('click', function(event) {
                const card = this.closest('.card');
                if (!card) return;
                
                // Não expandir/retrair se o clique for em um link ou botão DENTRO do header (se houver)
                // if (event.target.closest('a, button')) { return; }
                
                card.classList.toggle('expanded');
            });
        });

        document.querySelectorAll('.btn-comentar').forEach(button => {
            button.addEventListener('click', function() {
                const sheetRowId = this.dataset.sheetRow;
                if (!sheetRowId) {
                    alert('ID da linha (sheetRow) não encontrado para adicionar comentário.');
                    debug('Erro: Botão comentar clicado, mas data-sheet-row está faltando ou vazio.');
                    return;
                }
                const commentText = prompt("Digite seu comentário:");
                if (commentText !== null && commentText.trim() !== "") {
                    const now = new Date();
                    const formattedTimestamp = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')} - ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}h: `;
                    const fullComment = formattedTimestamp + commentText;
                    sendDataToSheet({ action: 'addComment', row: sheetRowId, comment: fullComment });
                }
            });
        });

        document.querySelectorAll('.btn-aprovacao').forEach(button => {
            button.addEventListener('click', function() {
                const sheetRowId = this.dataset.sheetRow;
                 if (!sheetRowId) {
                    alert('ID da linha (sheetRow) não encontrado para atualizar aprovação.');
                    debug('Erro: Botão aprovação clicado, mas data-sheet-row está faltando ou vazio.');
                    return;
                }
                const newStatus = prompt("Digite o novo status de aprovação (ex: Aprovado, Reprovado, Pendente):");
                if (newStatus !== null && newStatus.trim() !== "") {
                    // No Apps Script, a função é updateColumnI, que espera 'value'
                    sendDataToSheet({ action: 'updateI', row: sheetRowId, value: newStatus });
                }
            });
        });
    }

    function sendDataToSheet(payload) {
        debug(`Enviando para Apps Script: ${JSON.stringify(payload)}`);
        
        // O Apps Script espera um POST com JSON no corpo
        fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors', // Importante para evitar erro de CORS com Apps Script simples
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json' // Embora no-cors, é boa prática
            },
            body: JSON.stringify(payload),
            redirect: 'follow' // Necessário para Apps Script que redireciona após POST
        })
        .then(response => {
            // Com mode: 'no-cors', a response é opaca, não podemos ler o status ou corpo diretamente.
            // Assumimos sucesso se a requisição não gerar um erro de rede.
            debug('Dados enviados para a planilha (resposta opaca devido a no-cors).');
            alert('Ação enviada para a planilha. Pode ser necessário recarregar a página para ver as atualizações.');
            // loadData(); // Opcional: recarregar dados. Pode ser disruptivo.
        })
        .catch(error => {
            debug(`Erro ao enviar dados para Apps Script: ${error}`);
            alert('Erro ao enviar dados para a planilha.');
        });
    }

    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>

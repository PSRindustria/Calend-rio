<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Cards</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
    #status { font-weight: bold; margin-bottom: 1rem; }
    ul { list-style: none; padding: 0; }
    li {
      display: flex; justify-content: space-between; align-items: center;
      padding: .5rem; border: 1px solid #ccc; border-radius: 4px;
      margin-bottom: .5rem;
    }
    li:hover { background: #f5f5f5; }
    .text-item { flex:1; cursor: pointer; }
    .btn { margin-left: .5rem; padding: .25rem .5rem; border: none;
           border-radius: 3px; cursor: pointer; }
    .btn-edit { background: #28a745; color: #fff; }
    .btn-comment { background: #007bff; color: #fff; }
    .btn-edit:hover { background: #218838; }
    .btn-comment:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h1>Painel de Cards</h1>
  <div id="status">Carregando…</div>
  <ul id="lista"></ul>

  <script>
    const BASE_URL = 'https://agenda-portal-2d149-default-rtdb.firebaseio.com/sheets/data';

    async function loadData() {
      document.getElementById('status').textContent = 'Carregando…';
      try {
        const res = await fetch(BASE_URL + '.json');
        if(!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        render(Array.isArray(data) ? data : []);
        document.getElementById('status').textContent = `Foram carregados ${data.length} registros.`;
      } catch(err) {
        document.getElementById('status').textContent = 'Erro: ' + err.message;
      }
    }

    function render(items) {
      const ul = document.getElementById('lista');
      ul.innerHTML = '';
      if (!items.length) {
        ul.innerHTML = '<li>Nenhum registro</li>';
        return;
      }
      items.forEach((item, idx) => {
        const li = document.createElement('li');
        // Texto
        const div = document.createElement('div');
        div.className = 'text-item';
        div.textContent = Object.entries(item)
          .filter(([k]) => !['comments','commentCount','I'].includes(k))
          .map(([k,v]) => `${k}: ${v}`)
          .join(' │ ');
        // Botão editar I
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-edit';
        btnEdit.textContent = `I: ${item.I||''}`;
        btnEdit.onclick = async () => {
          const novo = prompt('Novo valor para I:', item.I||'');
          if (novo === null) return;
          await fetch(`${BASE_URL}/${idx}/I.json`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(novo)
          });
          item.I = novo;
          btnEdit.textContent = `I: ${novo}`;
        };
        // Botão comentários
        const btnC = document.createElement('button');
        btnC.className = 'btn btn-comment';
        btnC.textContent = `Comentários (${item.commentCount||0})`;
        btnC.onclick = async () => {
          const anteriores = Array.isArray(item.comments) ? item.comments.join('\n') : '';
          const novo = prompt(
            anteriores 
              ? `Comentários anteriores:\n${anteriores}\n\nNovo:` 
              : 'Seu comentário:'
          );
          if (!novo) return;
          const lista = Array.isArray(item.comments) 
            ? [...item.comments, novo] 
            : [novo];
          await fetch(`${BASE_URL}/${idx}.json`, {
            method: 'PATCH',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              comments: lista,
              commentCount: lista.length
            })
          });
          item.comments = lista;
          item.commentCount = lista.length;
          btnC.textContent = `Comentários (${lista.length})`;
        };

        li.append(div, btnEdit, btnC);
        ul.appendChild(li);
      });
    }

    window.onload = loadData;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Cards</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --success: #4cc9f0;
      --warning: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --border-radius: 8px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 1.5rem;
      background-color: #f0f2f5;
      color: var(--dark);
    }
    
    .header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .header h1 {
      color: var(--primary);
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
    }
    
    #status {
      font-weight: 500;
      color: var(--gray);
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .date-navigator {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .date-btn {
      background-color: white;
      border: 1px solid var(--primary-light);
      color: var(--primary);
      border-radius: var(--border-radius);
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .date-btn:hover {
      background-color: var(--primary-light);
      color: white;
    }
    
    .date-btn.active {
      background-color: var(--primary);
      color: white;
    }
    
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    
    .card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      transition: var(--transition);
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
      background-color: var(--primary);
      color: white;
      padding: 0.75rem 1rem;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card.status-aprovado .card-header {
      background-color: #28a745;
    }
    
    .card.status-reprovado .card-header {
      background-color: #dc3545;
    }
    
    .card.status-pendente .card-header {
      background-color: #ffc107;
      color: #212529;
    }
    
    .card-title {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .social-icon {
      font-size: 18px;
      margin-right: 6px;
    }
    
    .card-content {
      padding: 1rem;
      cursor: pointer;
    }
    
    .card-preview {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .card-field {
      display: flex;
      align-items: center;
    }
    
    .field-label {
      font-weight: 500;
      color: var(--gray);
      width: 80px;
      flex-shrink: 0;
    }
    
    .field-value {
      flex-grow: 1;
    }
    
    .link-field {
      color: var(--primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .link-field:hover {
      text-decoration: underline;
    }
    
    .link-field i {
      font-size: 14px;
    }
    
    .card-details {
      display: none;
      border-top: 1px solid #eee;
      margin-top: 1rem;
      padding-top: 1rem;
    }
    
    .card-actions {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 0.5rem;
      border-top: 1px dashed #eee;
    }
    
    .btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }
    
    .btn-success {
      background-color: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background-color: #3db8db;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-light);
    }
    
    .card.expanded .card-details {
      display: block;
    }
    
    .card.expanded .expand-icon::before {
      content: '\f077';
    }
    
    .expand-icon::before {
      content: '\f078';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
    }
    
    .empty-state {
      text-align: center;
      padding: 2rem;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }
    
    .empty-state i {
      font-size: 3rem;
      color: var(--gray);
      margin-bottom: 1rem;
    }
    
    .empty-state h3 {
      color: var(--gray);
      margin-bottom: 0.5rem;
    }
    
    .debug-panel {
      margin-top: 2rem;
      padding: 1rem;
      border: 1px dashed #ccc;
      border-radius: var(--border-radius);
      display: none;
      background-color: #f8f9fa;
    }
    
    .debug-panel h3 {
      color: var(--gray);
      margin-top: 0;
      font-size: 1rem;
    }
    
    .debug-content {
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Painel de Cards</h1>
  </div>
  
  <div id="status">Carregando dados...</div>
  
  <div class="date-navigator" id="dateFilter"></div>
  
  <div id="cardContainer" class="card-container"></div>
  
  <div id="debug" class="debug-panel">
    <h3>Log de Depuração</h3>
    <div class="debug-content"></div>
  </div>

  <script>
    const WEB_APP = 'https://script.google.com/macros/s/AKfycby8yXZAoOsfkc6Mlt0jcs3lK2V0l-zM6nWo00otZhIajM_Odi24VFsBmdZJDKMaI_9hcw/exec';
    
    let allData = [];
    let availableDates = [];
    let currentDateFilter = null;

    function debug(message) {
      const debugPanel = document.getElementById('debug');
      const debugContent = debugPanel.querySelector('.debug-content');
      debugPanel.style.display = 'block';
      const timestamp = new Date().toLocaleTimeString();
      debugContent.innerHTML += `<div>${timestamp}: ${message}</div>`;
    }

    function loadData() {
      document.getElementById('status').textContent = 'Carregando dados...';
      window.handleData = function(items) {
        allData = items;
        
        extractDates();
        
        renderDateFilters();
        
        if (availableDates.length > 0) {
          filterByDate(availableDates[0]);
        } else {
          renderCards(allData);
        }
        
        document.getElementById('status').textContent = `${allData.length} registros carregados.`;
        delete window.handleData;
      };
      
      const script = document.createElement('script');
      script.src = `${WEB_APP}?action=getData&callback=handleData`;
      document.head.appendChild(script);
    }
    
    function extractDates() {
      const dateField = findDateField();
      
      if (!dateField) {
        debug("Nenhum campo de data identificado nos dados");
        return;
      }
      
      const dateMap = {};
      
      allData.forEach(item => {
        if (item[dateField]) {
          let dateValue;
          try {
            if (typeof item[dateField] === 'string') {
              if (item[dateField].includes('/')) {
                const parts = item[dateField].split('/');
                if (parts.length === 3) {
                  dateValue = new Date(parts[2], parts[1]-1, parts[0]);
                  
                  if (isNaN(dateValue.getTime())) {
                    dateValue = new Date(parts[2], parts[0]-1, parts[1]);
                  }
                } else if (parts.length === 2) {
                  const currentYear = new Date().getFullYear();
                  dateValue = new Date(currentYear, parts[1]-1, parts[0]);
                }
              } else {
                dateValue = new Date(item[dateField]);
              }
            } else if (item[dateField] instanceof Date) {
              dateValue = item[dateField];
            }
            
            if (dateValue && !isNaN(dateValue.getTime())) {
              const month = dateValue.getMonth();
              const year = dateValue.getFullYear();
              const key = `${year}-${month}`;
              
              if (!dateMap[key]) {
                dateMap[key] = {
                  year: year,
                  month: month,
                  label: getMonthName(month) + ' ' + year
                };
              }
            }
          } catch (e) {
            debug(`Erro ao analisar data: ${e.message}`);
          }
        }
      });
      
      const currentDate = new Date();
      const currentMonth = currentDate.getMonth();
      const currentYear = currentDate.getFullYear();
      
      availableDates = Object.values(dateMap).sort((a, b) => {
        if (a.month === currentMonth && a.year === currentYear) return -1;
        if (b.month === currentMonth && b.year === currentYear) return 1;
        
        if (a.year !== b.year) return a.year - b.year;
        return a.month - b.month;
      });
    }
    
    function findDateField() {
      if (allData.length === 0) return null;
      
      const possibleDateFields = ['data', 'date', 'dt', 'dataCriacao', 'dataRegistro', 'dataEntrada'];
      
      for (const field of possibleDateFields) {
        if (allData[0].hasOwnProperty(field)) {
          return field;
        }
      }
      
      for (const key in allData[0]) {
        const value = allData[0][key];
        if (value) {
          if (typeof value === 'string' && (
              value.includes('/') || 
              value.match(/\d{4}-\d{2}-\d{2}/) ||
              !isNaN(new Date(value).getTime())
          )) {
            return key;
          }
          
          if (value instanceof Date) {
            return key;
          }
        }
      }
      
      return null;
    }
    
    function getMonthName(monthIndex) {
      const months = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      return months[monthIndex];
    }
    
    function renderDateFilters() {
      const filterContainer = document.getElementById('dateFilter');
      filterContainer.innerHTML = '';
      
      if (availableDates.length === 0) {
        filterContainer.innerHTML = '<div class="date-btn disabled">Sem datas disponíveis</div>';
        return;
      }
      
      const allButton = document.createElement('button');
      allButton.className = 'date-btn' + (currentDateFilter === null ? ' active' : '');
      allButton.textContent = 'Todos';
      allButton.onclick = () => filterByDate(null);
      filterContainer.appendChild(allButton);
      
      availableDates.forEach(dateObj => {
        const btn = document.createElement('button');
        btn.className = 'date-btn';
        if (currentDateFilter && 
            currentDateFilter.year === dateObj.year && 
            currentDateFilter.month === dateObj.month) {
          btn.classList.add('active');
        }
        btn.textContent = dateObj.label;
        btn.onclick = () => filterByDate(dateObj);
        filterContainer.appendChild(btn);
      });
    }
    
    function filterByDate(dateObj) {
      currentDateFilter = dateObj;
      
      const filterButtons = document.querySelectorAll('.date-btn');
      filterButtons.forEach(btn => btn.classList.remove('active'));
      
      if (dateObj === null) {
        document.querySelector('.date-btn:first-child').classList.add('active');
        
        const dateField = findDateField();
        const sortedData = [...allData].sort((a, b) => {
          const dateA = parseDate(a[dateField]);
          const dateB = parseDate(b[dateField]);
          
          if (!dateA && !dateB) return 0;
          if (!dateA) return 1;
          if (!dateB) return -1;
          
          return dateA - dateB;
        });
        
        renderCards(sortedData);
        return;
      }
      
      filterButtons.forEach(btn => {
        if (btn.textContent === dateObj.label) {
          btn.classList.add('active');
        }
      });
      
      const dateField = findDateField();
      const filteredData = allData.filter(item => {
        if (!item[dateField]) return false;
        
        let itemDate = parseDate(item[dateField]);
        
        return itemDate && 
               itemDate.getMonth() === dateObj.month && 
               itemDate.getFullYear() === dateObj.year;
      });
      
      filteredData.sort((a, b) => {
        const dateA = parseDate(a[dateField]);
        const dateB = parseDate(b[dateField]);
        
        if (!dateA && !dateB) return 0;
        if (!dateA) return 1;
        if (!dateB) return -1;
        
        return dateA - dateB;
      });
      
      renderCards(filteredData);
    }
    
    function parseDate(dateStr) {
      if (!dateStr) return null;
      
      try {
        if (dateStr instanceof Date) return dateStr;
        
        if (typeof dateStr === 'string') {
          if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
              return new Date(parts[2], parts[1]-1, parts[0]);
            } else if (parts.length === 2) {
              const currentYear = new Date().getFullYear();
              return new Date(currentYear, parts[1]-1, parts[0]);
            }
          } else {
            return new Date(dateStr);
          }
        }
      } catch (e) {
        debug(`Erro ao analisar data: ${dateStr}`);
      }
      
      return null;
    }

    function renderCards(items) {
      const container = document.getElementById('cardContainer');
      container.innerHTML = '';
      
      if (!items || items.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-search"></i>
            <h3>Nenhum registro encontrado</h3>
            <p>Tente selecionar outro período ou verifique os dados.</p>
          </div>
        `;
        return;
      }
      
      items.forEach(item => {
        const allColumns = Object.entries(item)
          .filter(([key]) => !['_row', 'comments', 'commentCount'].includes(key));
        
        const previewColumns = [
          allColumns[0],
          allColumns[1],
          allColumns.length >= 5 ? allColumns[4] : null,
          allColumns.length >= 8 ? allColumns[7] : null,
        ].filter(Boolean);
        
        const statusField = findStatusField(item);
        let statusClass = '';
        if (statusField) {
          const statusValue = (item[statusField] || '').toString().toLowerCase();
          if (statusValue.includes('aprovado')) {
            statusClass = 'status-aprovado';
          } else if (statusValue.includes('reprovado')) {
            statusClass = 'status-reprovado';
          } else if (statusValue.includes('pendente')) {
            statusClass = 'status-pendente';
          }
        }
        
        const platformField = findPlatformField(item);
        let socialIcon = '';
        if (platformField) {
          const platform = (item[platformField] || '').toString().toLowerCase();
          if (platform.includes('instagram')) {
            socialIcon = '<i class="fab fa-instagram social-icon"></i>';
          } else if (platform.includes('linkedin')) {
            socialIcon = '<i class="fab fa-linkedin social-icon"></i>';
          } else if (platform.includes('facebook')) {
            socialIcon = '<i class="fab fa-facebook social-icon"></i>';
          } else if (platform.includes('youtube')) {
            socialIcon = '<i class="fab fa-youtube social-icon"></i>';
          } else if (platform.includes('tiktok')) {
            socialIcon = '<i class="fab fa-tiktok social-icon"></i>';
          }
        }
        
        const card = document.createElement('div');
        card.className = `card ${statusClass}`;
        card.setAttribute('data-card-id', item._row);
        
        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header';
        cardHeader.innerHTML = `
          <div class="card-title">${socialIcon}${previewColumns[0] ? previewColumns[0][1] : ''}</div>
          <span class="expand-icon"></span>
        `;
        
        function formatDateValue(key, value) {
          const dateField = findDateField();
          if (key === dateField && value) {
            try {
              const dateObj = parseDate(value);
              if (dateObj) {
                const day = dateObj.getDate().toString().padStart(2, '0');
                const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                return `${day}/${month}`;
              }
            } catch (e) {
            }
          }
          return value || '';
        }
        
        function formatFieldValue(key, value) {
          if (!value) return '';
          
          if (typeof value === 'string' && 
              (value.includes('drive.google.com') || 
               value.includes('http://') || 
               value.includes('https://'))) {
            return `<a href="${value}" target="_blank" class="link-field">
                     ${value.length > 30 ? value.substring(0, 30) + '...' : value}
                     <i class="fas fa-external-link-alt"></i>
                   </a>`;
          }
          
          return formatDateValue(key, value);
        }
        
        const cardContent = document.createElement('div');
        cardContent.className = 'card-content';
        cardContent.innerHTML = `
          <div class="card-preview">
            ${previewColumns.slice(1).map(([key, value]) => `
              <div class="card-field">
                <div class="field-label">${key}:</div>
                <div class="field-value">${formatFieldValue(key, value)}</div>
              </div>
            `).join('')}
          </div>
          <div class="card-details">
            ${allColumns.map(([key, value], index) => {
              if (previewColumns.some(col => col[0] === key)) return '';
              return `
                <div class="card-field">
                  <div class="field-label">${key}:</div>
                  <div class="field-value">${formatFieldValue(key, value)}</div>
                </div>
              `;
            }).join('')}
            <div class="card-actions">
              <button class="btn btn-success btn-evaluate" data-row="${item._row}" data-value="${item.I || ''}">
                <i class="fas fa-star"></i> Aprovação
              </button>
              <button class="btn btn-primary btn-comment" data-row="${item._row}" data-count="${item.commentCount || 0}">
                <i class="fas fa-comment"></i> Comentar
              </button>
            </div>
          </div>
        `;
        
        cardContent.addEventListener('click', (e) => {
          if (e.target.closest('.btn') || e.target.closest('a')) return;
          
          card.classList.toggle('expanded');
        });
        
        card.appendChild(cardHeader);
        card.appendChild(cardContent);
        container.appendChild(card);
      });
      
      addButtonEvents();
    }
    
    function findStatusField(item) {
      if (item['I'] !== undefined) {
        return 'I';
      }
      
      const possibleFields = ['status', 'Status', 'situacao', 'Situacao', 'Situação', 'situação', 'aprovacao', 'Aprovacao'];
      
      for (const field of possibleFields) {
        if (item[field] !== undefined) {
          return field;
        }
      }
      
      for (const [key, value] of Object.entries(item)) {
        if (value && typeof value === 'string') {
          const lowerValue = value.toLowerCase();
          if (lowerValue.includes('aprovado') || 
              lowerValue.includes('reprovado') || 
              lowerValue.includes('pendente')) {
            return key;
          }
        }
      }
      
      return null;
    }
    
    function findPlatformField(item) {
      const possibleFields = ['plataforma', 'Plataforma', 'platform', 'Platform', 'rede', 'Rede', 'redeSocial', 'RedeSocial'];
      
      for (const field of possibleFields) {
        if (item[field] !== undefined) {
          return field;
        }
      }
      
      for (const [key, value] of Object.entries(item)) {
        if (value && typeof value === 'string') {
          const lowerValue = value.toLowerCase();
          if (lowerValue.includes('instagram') || 
              lowerValue.includes('facebook') || 
              lowerValue.includes('linkedin') || 
              lowerValue.includes('youtube') || 
              lowerValue.includes('tiktok')) {
            return key;
          }
        }
      }
      
      return null;
    }
    
    function addButtonEvents() {
      document.querySelectorAll('.btn-evaluate').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const row = btn.dataset.row;
          const currentValue = btn.dataset.value;
          
          const novo = prompt('Avaliação:', currentValue || '');
          if (novo === null) return;
          
          debug(`Enviando avaliação para linha ${row}, valor: ${novo}`);
          
          const data = {
            action: 'updateI',
            row: row,
            value: novo
          };
          
          fetch(WEB_APP, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(response => {
            debug(`Resposta recebida para avaliação`);
            setTimeout(loadData, 1000);
          })
          .catch(error => {
            debug(`Erro ao atualizar: ${error}`);
          });
        });
      });
      
      document.querySelectorAll('.btn-comment').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const row = btn.dataset.row;
          const commentCount = parseInt(btn.dataset.count) || 0;
          
          const commentsData = {
            action: 'getComments',
            row: row
          };
          
          function showCommentsModal(comments = []) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            
            modal.innerHTML = `
              <div style="background: white; width: 90%; max-width: 500px; border-radius: var(--border-radius); padding: 1.5rem; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <h3 style="margin: 0;">Comentários</h3>
                  <button id="closeModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                </div>
                <div id="commentsList" style="margin-bottom: 1rem;">
                  ${comments.length === 0 ? '<p>Nenhum comentário ainda.</p>' : ''}
                  ${comments.map((comment, index) => `
                    <div style="padding: 0.75rem; background: #f8f9fa; margin-bottom: 0.5rem; border-radius: var(--border-radius);">
                      <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 0.25rem;">
                        ${comment.date || 'Sem data'}
                      </div>
                      <div>${comment.text || ''}</div>
                    </div>
                  `).join('')}
                </div>
                <div>
                  <textarea id="newComment" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: var(--border-radius); margin-bottom: 0.5rem;" placeholder="Adicione um comentário..."></textarea>
                  <button id="addComment" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-paper-plane"></i> Enviar
                  </button>
                </div>
              </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('closeModal').addEventListener('click', () => {
              document.body.removeChild(modal);
            });
            
            document.getElementById('addComment').addEventListener('click', () => {
              const text = document.getElementById('newComment').value.trim();
              if (!text) return;
              
              const commentData = {
                action: 'addComment',
                row: row,
                text: text
              };
              
              fetch(WEB_APP, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(commentData)
              })
              .then(response => {
                debug(`Comentário enviado para linha ${row}`);
                document.body.removeChild(modal);
                setTimeout(loadData, 1000);
              })
              .catch(error => {
                debug(`Erro ao enviar comentário: ${error}`);
              });
            });
          }
          
          if (allData) {
            const item = allData.find(d => d._row == row);
            if (item && item.comments) {
              showCommentsModal(item.comments);
              return;
            }
          }
          
          debug(`Buscando comentários para linha ${row}`);
          fetch(`${WEB_APP}?action=getComments&row=${row}`)
            .then(response => response.json())
            .then(data => {
              debug(`Comentários recebidos: ${data.length}`);
              showCommentsModal(data);
            })
            .catch(error => {
              debug(`Erro ao buscar comentários: ${error}`);
              showCommentsModal([]);
            });
        });
      });
    }
    
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
